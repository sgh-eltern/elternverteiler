#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift(File.expand_path('../lib', __dir__))

require 'sequel'
Sequel::Model.db = Sequel.connect(ENV.fetch('DB'))
Sequel.extension :migration
Sequel::Migrator.run(Sequel::Model.db, 'db/migrations')

require 'sgh/elternverteiler'

# rubocop:disable Style/MixinUsage
include SGH::Elternverteiler
# rubocop:enable Style/MixinUsage

require 'sgh/elternverteiler/postmap_presenter'

Klasse.each do |klasse|
  warn "#{klasse}: #{klasse.schüler.count} Schüler, #{klasse.eltern.count} Eltern"
  puts PostmapPresenter.new("eltern-#{klasse.to_s.downcase}@schickhardt-gymnasium-herrenberg.de").present(klasse.eltern)
end

Klasse.all.group_by(&:stufe).each do |klassenstufe, klassen|
  eltern = klassen.flat_map(&:eltern)
  warn "Klassenstufe #{klassenstufe}: #{klassen.flat_map(&:schüler).count} Schüler, #{eltern.count} Eltern"
  puts PostmapPresenter.new("eltern-#{klassenstufe.to_s.downcase}@schickhardt-gymnasium-herrenberg.de").present(eltern)
end

warn "Alle Eltern: #{Erziehungsberechtigter.count} Adressen"
puts PostmapPresenter.new('eltern@schickhardt-gymnasium-herrenberg.de').present(Erziehungsberechtigter.all)

elternbeirat = Amt.where(name: '1.EV').or(name: '2.EV').map(&:mitglieder).flatten
warn "Elternbeirat: #{elternbeirat.count} Adressen"
puts PostmapPresenter.new('elternbeirat@schickhardt-gymnasium-herrenberg.de').present(elternbeirat)

evsk = Amt.where(name: 'SK').map(&:mitglieder).flatten
warn "Elternvertreter in der Schulkonferenz: #{evsk.count} Adressen"
puts PostmapPresenter.new('elternvertreter-schulkonferenz@schickhardt-gymnasium-herrenberg.de').present(evsk)

ebv = Amt.where(name: '1.EBV').or(name: '2.EBV').map(&:mitglieder).flatten
warn "Elternbeiratsvorsitzende: #{ebv.count} Adressen"
puts PostmapPresenter.new('elternbeiratsvorsitzende@schickhardt-gymnasium-herrenberg.de').present(ebv)

unreachable = Schüler.all.select { |sch| sch.eltern.collect(&:mail).compact.empty? }

if unreachable.any?
  percent = unreachable.count.to_f / Schüler.count * 100
  warn "Nicht per Mail erreichbar sind (#{sprintf('%.2f%%', percent)}):"
  warn unreachable
end
